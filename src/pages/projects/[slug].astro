---
/**
 * Case Study Detail Page
 * 
 * Dynamic route that displays a comprehensive project case study following a structured
 * narrative format. Presents the complete story of a project from problem identification
 * through to measurable impact and learnings.
 * 
 * Narrative Structure (enforced order):
 * 1. Overview - High-level project summary
 * 2. Problem - Challenge being addressed
 * 3. Constraints - Limitations and boundaries
 * 4. Approach - Solution strategy
 * 5. Tech Stack - Technologies used
 * 6. Result & Impact - Quantitative metrics and qualitative outcomes
 * 7. Learnings - Insights and takeaways
 * 
 * Features:
 * - Static path generation for all project entries
 * - Structured case study presentation
 * - Impact metrics grid (when available)
 * - Reading time calculation
 * - Structured data for SEO
 * - Optional additional markdown content
 * - Scroll-to-top functionality
 * - Related content navigation
 * - Back navigation to projects list
 * 
 * Route: /projects/[slug]
 * 
 * @page
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import StructuredData from '../../components/StructuredData.astro';
import ScrollToTop from '../../components/ScrollToTop.astro';
import BackLink from '../../components/BackLink.astro';
import RelatedContent from '../../components/RelatedContent.astro';
import ImpactMetrics from '../../components/ImpactMetrics.astro';
import { getCollection, getEntry, render } from 'astro:content';
import { calculateReadingTime, formatReadingTime } from '../../utils/readingTime';

/**
 * Generates static paths for all project entries
 * 
 * Queries the projects content collection and creates a route for each entry
 * using the entry ID as the slug parameter.
 * 
 * @returns Array of path objects with params
 */
export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.id },
  }));
}

const { slug } = Astro.params;

/**
 * Retrieves the specific project entry by slug
 * 
 * Redirects to 404 if the project is not found.
 */
const project = await getEntry('projects', slug!);

if (!project) {
  return Astro.redirect('/404');
}

// Render the content (v6-compatible method)
const { Content } = await render(project);

const {
  title,
  role,
  year,
  duration,
  teamSize,
  outcomeSummary,
  overview,
  problem,
  constraints,
  approach,
  techStack,
  impact,
  learnings,
  relatedProjects,
  status,
  githubUrl,
} = project.data;

// Status display configuration
const statusConfig = {
  completed: { label: 'Completed', class: 'status--completed' },
  ongoing: { label: 'Ongoing', class: 'status--ongoing' },
  archived: { label: 'Archived', class: 'status--archived' },
};
const statusInfo = statusConfig[status || 'completed'];

/**
 * Calculates reading time from all case study content
 * 
 * Combines all text sections including overview, problem, approach,
 * impact, learnings, and optional markdown body to estimate total reading time.
 */
const allText = [
  overview,
  problem,
  approach,
  ...constraints,
  impact.qualitative,
  ...learnings,
  project.body || '',
].join(' ');
const readingTime = formatReadingTime(calculateReadingTime(allText));
---

<BaseLayout>
  <SEO 
    slot="head"
    title={`${title} - Case Study`}
    description={outcomeSummary}
    type="article"
  />

  <StructuredData
    type="Project"
    data={{
      title,
      outcomeSummary,
      problem,
      impact: impact.qualitative,
      techStack,
      year,
    }}
  />

  <main class="case-study">
    <!-- Case Study Header -->
    <header class="case-study-header">
      <div class="header-badges">
        {status && status !== 'completed' && (
          <span class:list={['status-badge', statusInfo.class]}>
            {statusInfo.label}
          </span>
        )}
      </div>
      <h1>{title}</h1>
      <div class="case-study-meta">
        <span class="meta-item">{role}</span>
        <span class="meta-separator">·</span>
        <span class="meta-item">{year}</span>
        {duration && (
          <>
            <span class="meta-separator">·</span>
            <span class="meta-item">{duration}</span>
          </>
        )}
        {teamSize && (
          <>
            <span class="meta-separator">·</span>
            <span class="meta-item">{teamSize} {teamSize === 1 ? 'person' : 'people'}</span>
          </>
        )}
        <span class="meta-separator">·</span>
        <span class="meta-item">{readingTime}</span>
      </div>
      <p class="outcome-summary">{outcomeSummary}</p>
      {githubUrl && (
        <a href={githubUrl} target="_blank" rel="noopener noreferrer" class="github-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
          View on GitHub
        </a>
      )}
    </header>

    <!-- Overview Section -->
    <section class="case-study-section">
      <h2>Overview</h2>
      <p>{overview}</p>
    </section>

    <!-- Problem Section -->
    <section class="case-study-section">
      <h2>Problem</h2>
      <p>{problem}</p>
    </section>

    <!-- Constraints Section -->
    <section class="case-study-section">
      <h2>Constraints</h2>
      <ul class="constraints-list">
        {constraints.map((constraint) => (
          <li>{constraint}</li>
        ))}
      </ul>
    </section>

    <!-- Approach Section -->
    <section class="case-study-section">
      <h2>Approach</h2>
      <p>{approach}</p>
    </section>

    <!-- Tech Stack Section -->
    <section class="case-study-section">
      <h2>Tech Stack</h2>
      <ul class="tech-stack-list">
        {techStack.map((tech) => (
          <li>{tech}</li>
        ))}
      </ul>
    </section>

    <!-- Result/Impact Section -->
    <section class="case-study-section">
      <h2>Result & Impact</h2>
      
      {/* Display metrics with visualization */}
      {impact.metrics && impact.metrics.length > 0 && (
        <ImpactMetrics metrics={impact.metrics} />
      )}
      
      <p class="impact-qualitative">{impact.qualitative}</p>
    </section>

    <!-- Learnings Section -->
    <section class="case-study-section">
      <h2>Learnings</h2>
      <ul class="learnings-list">
        {learnings.map((learning) => (
          <li>{learning}</li>
        ))}
      </ul>
    </section>

    <!-- Additional MDX Content (if any) -->
    {Content && (
      <section class="case-study-content">
        <Content />
      </section>
    )}

    <!-- Related Content -->
    <RelatedContent 
      relatedProjects={relatedProjects} 
    />

    <BackLink href="/projects" text="All projects" />
  </main>

  <ScrollToTop />

  <style>
    .case-study {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .case-study-header {
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--color-border);
    }

    .header-badges {
      margin-bottom: 0.75rem;
    }

    .header-badges:empty {
      display: none;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.3rem 0.625rem;
      border-radius: 4px;
    }

    .status--ongoing {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .status--archived {
      background: rgba(115, 115, 115, 0.15);
      color: var(--color-text-muted);
    }

    .case-study-header h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .case-study-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9375rem;
      color: var(--color-text-secondary);
      margin-bottom: 1.5rem;
    }

    .meta-separator {
      opacity: 0.5;
    }

    .outcome-summary {
      font-size: 1.125rem;
      line-height: 1.6;
      color: var(--color-text-secondary);
      margin-bottom: 1.25rem;
    }

    .github-link {
      display: inline-flex;
      align-items: center;
      gap: 0.625rem;
      font-size: 1rem;
      font-weight: 500;
      color: var(--color-text);
      text-decoration: none;
      padding: 0.625rem 1.25rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      transition: all 0.2s ease;
      background: var(--color-bg-secondary);
    }

    .github-link:hover {
      color: var(--color-accent);
      border-color: var(--color-accent);
      background: var(--color-bg);
    }

    .github-link svg {
      flex-shrink: 0;
    }

    .case-study-section {
      margin-bottom: 3rem;
    }

    .case-study-section h2 {
      font-size: 1.75rem;
      margin-bottom: 1.25rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .case-study-section p {
      font-size: 1.125rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
    }

    .constraints-list,
    .tech-stack-list,
    .learnings-list {
      list-style: none;
      padding: 0;
    }

    .constraints-list li,
    .tech-stack-list li,
    .learnings-list li {
      font-size: 1.0625rem;
      line-height: 1.7;
      padding: 0.5rem 0;
      padding-left: 1.5rem;
      position: relative;
      color: var(--color-text-secondary);
    }

    .constraints-list li::before,
    .tech-stack-list li::before,
    .learnings-list li::before {
      content: "→";
      position: absolute;
      left: 0;
      color: var(--color-accent);
    }

    .impact-qualitative {
      font-size: 1.125rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
    }

    .case-study-content {
      margin-top: 3rem;
      font-size: 1.0625rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
    }

    @media (max-width: 768px) {
      .case-study {
        padding: 1.5rem 1rem;
      }

      .case-study-header h1 {
        font-size: 2rem;
      }

      .outcome-summary {
        font-size: 1.125rem;
      }

      .case-study-section h2 {
        font-size: 1.5rem;
      }

      .case-study-section p {
        font-size: 1rem;
      }
    }
  </style>
</BaseLayout>
